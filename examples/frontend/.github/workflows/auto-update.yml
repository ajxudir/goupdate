# Auto Update Workflow
# Automated dependency updates via PR
#
# Usage:
#   1. Copy this .github folder to your repository
#   2. Modify the env section below for your project
#   3. Push to your repository
#
# Supported Package Managers:
#   - Node.js: npm, yarn, pnpm
#   - PHP: composer
#   - Python: requirements (pip), pipfile (pipenv)
#   - Go: mod
#   - .NET: nuget
#
# Multiple Package Managers:
#   Enable multiple package managers for projects like Laravel (composer + npm),
#   Django (requirements + npm), or full-stack apps.
#   Only the tools you enable will be installed.
#
# Update Policy:
#   - Minor/Patch updates: Applied automatically
#   - Major updates: Alerts only, does not block other updates

name: Auto Update Dependencies

on:
  schedule:
    - cron: '0 0 * * 1'  # Weekly on Monday

  workflow_dispatch:
    inputs:
      mode:
        description: 'Operation mode'
        required: true
        default: 'update'
        type: choice
        options:
          - check-only
          - update
      update-type:
        description: 'Dependency update type'
        required: false
        default: 'minor'
        type: choice
        options:
          - minor
          - patch

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

# ============================================================================
# CONFIGURATION - Modify for your project
# ============================================================================
env:
  # Goupdate source (change to your org's fork if needed)
  GOUPDATE_REPO: 'ajxudir/goupdate'

  # -------------------------------------------------------------------------
  # Package Managers - Enable the ones your project uses
  # Set to 'true' to enable, 'false' to disable
  # -------------------------------------------------------------------------
  # Node.js package managers
  ENABLE_NPM: 'false'
  ENABLE_YARN: 'false'
  ENABLE_PNPM: 'true'       # Frontend uses pnpm

  # PHP package manager
  ENABLE_COMPOSER: 'false'

  # Python package managers
  ENABLE_PIP: 'false'         # requirements.txt
  ENABLE_PIPENV: 'false'      # Pipfile

  # Go package manager
  ENABLE_GO: 'false'

  # .NET package manager
  ENABLE_NUGET: 'false'

  # -------------------------------------------------------------------------
  # Language Versions - Configure versions for enabled package managers
  # -------------------------------------------------------------------------
  NODE_VERSION: '20'        # For npm, yarn, pnpm
  PHP_VERSION: '8.2'        # For composer
  PYTHON_VERSION: '3.12'    # For pip, pipenv
  GO_VERSION: '1.24'        # For go mod
  DOTNET_VERSION: '8.0'     # For nuget

  # -------------------------------------------------------------------------
  # Branch Settings
  # -------------------------------------------------------------------------
  UPDATE_BRANCH: 'goupdate/auto-update'
  TARGET_BRANCH: 'stage-updates'

  # -------------------------------------------------------------------------
  # PR Settings - use {date} for current date, {type} for update type
  # -------------------------------------------------------------------------
  PR_TITLE: 'chore(deps): Auto update - {type} ({date})'

  # -------------------------------------------------------------------------
  # Test Command - runs after updates (set to empty to skip)
  # -------------------------------------------------------------------------
  TEST_COMMAND: 'pnpm run build'

  # -------------------------------------------------------------------------
  # Packages to exclude (comma-separated)
  # -------------------------------------------------------------------------
  EXCLUDE_PACKAGES: ''

permissions:
  contents: write
  pull-requests: write

jobs:
  prepare:
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      run-updates: ${{ steps.config.outputs.run_updates }}
      update-type: ${{ steps.config.outputs.update_type }}
      use-node: ${{ steps.detect.outputs.use_node }}
      use-php: ${{ steps.detect.outputs.use_php }}
      use-python: ${{ steps.detect.outputs.use_python }}
      use-go: ${{ steps.detect.outputs.use_go }}
      use-dotnet: ${{ steps.detect.outputs.use_dotnet }}
      rules: ${{ steps.detect.outputs.rules }}
    steps:
      - id: config
        run: |
          EVENT="${{ github.event_name }}"
          MODE="${{ github.event.inputs.mode }}"
          TYPE="${{ github.event.inputs.update-type }}"

          if [ "$EVENT" = "schedule" ]; then
            echo "run_updates=true" >> $GITHUB_OUTPUT
            echo "update_type=minor" >> $GITHUB_OUTPUT
          elif [ "$MODE" = "check-only" ]; then
            echo "run_updates=false" >> $GITHUB_OUTPUT
            echo "update_type=${TYPE:-minor}" >> $GITHUB_OUTPUT
          else
            echo "run_updates=true" >> $GITHUB_OUTPUT
            echo "update_type=${TYPE:-minor}" >> $GITHUB_OUTPUT
          fi

      - id: detect
        env:
          ENABLE_NPM: ${{ env.ENABLE_NPM }}
          ENABLE_YARN: ${{ env.ENABLE_YARN }}
          ENABLE_PNPM: ${{ env.ENABLE_PNPM }}
          ENABLE_COMPOSER: ${{ env.ENABLE_COMPOSER }}
          ENABLE_PIP: ${{ env.ENABLE_PIP }}
          ENABLE_PIPENV: ${{ env.ENABLE_PIPENV }}
          ENABLE_GO: ${{ env.ENABLE_GO }}
          ENABLE_NUGET: ${{ env.ENABLE_NUGET }}
        run: |
          USE_NODE="false"
          USE_PHP="false"
          USE_PYTHON="false"
          USE_GO="false"
          USE_DOTNET="false"
          RULES=""

          # Node.js package managers
          if [ "$ENABLE_NPM" = "true" ]; then
            USE_NODE="true"
            RULES="${RULES}npm,"
          fi
          if [ "$ENABLE_YARN" = "true" ]; then
            USE_NODE="true"
            RULES="${RULES}yarn,"
          fi
          if [ "$ENABLE_PNPM" = "true" ]; then
            USE_NODE="true"
            RULES="${RULES}pnpm,"
          fi

          # PHP
          if [ "$ENABLE_COMPOSER" = "true" ]; then
            USE_PHP="true"
            RULES="${RULES}composer,"
          fi

          # Python
          if [ "$ENABLE_PIP" = "true" ]; then
            USE_PYTHON="true"
            RULES="${RULES}requirements,"
          fi
          if [ "$ENABLE_PIPENV" = "true" ]; then
            USE_PYTHON="true"
            RULES="${RULES}pipfile,"
          fi

          # Go
          if [ "$ENABLE_GO" = "true" ]; then
            USE_GO="true"
            RULES="${RULES}mod,"
          fi

          # .NET
          if [ "$ENABLE_NUGET" = "true" ]; then
            USE_DOTNET="true"
            RULES="${RULES}nuget,"
          fi

          # Remove trailing comma
          RULES="${RULES%,}"

          echo "use_node=$USE_NODE" >> $GITHUB_OUTPUT
          echo "use_php=$USE_PHP" >> $GITHUB_OUTPUT
          echo "use_python=$USE_PYTHON" >> $GITHUB_OUTPUT
          echo "use_go=$USE_GO" >> $GITHUB_OUTPUT
          echo "use_dotnet=$USE_DOTNET" >> $GITHUB_OUTPUT
          echo "rules=$RULES" >> $GITHUB_OUTPUT

          echo "Enabled rules: $RULES"

  check:
    needs: prepare
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      has-updates: ${{ steps.goupdate.outputs.has-updates }}
      has-major-only: ${{ steps.goupdate.outputs.has-major-only }}
      summary: ${{ steps.goupdate.outputs.summary }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Ensure target branch
        uses: ./.github/actions/_git-branch
        with:
          branch: ${{ env.TARGET_BRANCH }}
          base: main
          create-if-missing: 'true'
          push: 'true'

      # -----------------------------------------------------------------------
      # Setup language runtimes (only those needed)
      # -----------------------------------------------------------------------
      - name: Setup Node.js
        if: needs.prepare.outputs.use-node == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Enable corepack
        if: env.ENABLE_YARN == 'true' || env.ENABLE_PNPM == 'true'
        run: corepack enable

      - name: Setup PHP
        if: needs.prepare.outputs.use-php == 'true'
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}

      - name: Setup Python
        if: needs.prepare.outputs.use-python == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install pipenv
        if: env.ENABLE_PIPENV == 'true'
        run: pip install pipenv

      - name: Setup Go
        if: needs.prepare.outputs.use-go == 'true'
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Setup .NET
        if: needs.prepare.outputs.use-dotnet == 'true'
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      # -----------------------------------------------------------------------
      # Check for updates (single command for all enabled rules)
      # -----------------------------------------------------------------------
      - name: Install goupdate
        uses: ./.github/actions/_goupdate-install
        with:
          goupdate-repo: ${{ env.GOUPDATE_REPO }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for updates
        id: goupdate
        uses: ./.github/actions/_goupdate-check
        with:
          rule: ${{ needs.prepare.outputs.rules }}
          exclude-packages: ${{ env.EXCLUDE_PACKAGES }}

      - name: Fail on major-only updates
        if: steps.goupdate.outputs.has-major-only == 'true' && steps.goupdate.outputs.has-updates == 'false'
        env:
          SUMMARY: ${{ steps.goupdate.outputs.summary }}
        run: |
          echo "::error::Only major updates available - no minor/patch updates to apply automatically"
          echo ""
          echo "=== MAJOR UPDATES REQUIRE MANUAL REVIEW ==="
          echo ""
          echo "Summary: $SUMMARY"
          echo ""
          echo "To resolve:"
          echo "  1. Review the changelogs for breaking changes"
          echo "  2. Update packages manually, or"
          echo "  3. Add packages to 'ignore' in .goupdate.yml to skip them"
          echo ""
          exit 1

  update:
    needs: [prepare, check]
    if: needs.prepare.outputs.run-updates == 'true' && needs.check.outputs.has-updates == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Ensure target branch
        uses: ./.github/actions/_git-branch
        with:
          branch: ${{ env.TARGET_BRANCH }}
          base: main
          create-if-missing: 'true'
          push: 'true'

      - name: Create update branch
        uses: ./.github/actions/_git-branch
        with:
          branch: ${{ env.UPDATE_BRANCH }}
          base: ${{ env.TARGET_BRANCH }}
          delete-remote: 'true'
          push: 'false'

      # -----------------------------------------------------------------------
      # Setup language runtimes (only those needed)
      # -----------------------------------------------------------------------
      - name: Setup Node.js
        if: needs.prepare.outputs.use-node == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Enable corepack
        if: env.ENABLE_YARN == 'true' || env.ENABLE_PNPM == 'true'
        run: corepack enable

      - name: Setup PHP
        if: needs.prepare.outputs.use-php == 'true'
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}

      - name: Setup Python
        if: needs.prepare.outputs.use-python == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Setup Go
        if: needs.prepare.outputs.use-go == 'true'
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Setup .NET
        if: needs.prepare.outputs.use-dotnet == 'true'
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      # -----------------------------------------------------------------------
      # Install dependencies (only those needed)
      # -----------------------------------------------------------------------
      - name: Install npm dependencies
        if: env.ENABLE_NPM == 'true'
        run: npm ci

      - name: Install yarn dependencies
        if: env.ENABLE_YARN == 'true'
        run: yarn install --frozen-lockfile

      - name: Install pnpm dependencies
        if: env.ENABLE_PNPM == 'true'
        run: pnpm install --frozen-lockfile

      - name: Install composer dependencies
        if: env.ENABLE_COMPOSER == 'true'
        run: composer install --no-interaction

      - name: Install pip dependencies
        if: env.ENABLE_PIP == 'true'
        run: pip install -r requirements.txt

      - name: Install pipenv dependencies
        if: env.ENABLE_PIPENV == 'true'
        run: |
          pip install pipenv
          pipenv install

      - name: Restore .NET dependencies
        if: env.ENABLE_NUGET == 'true'
        run: dotnet restore

      # -----------------------------------------------------------------------
      # Apply updates (single command for all enabled rules)
      # -----------------------------------------------------------------------
      - name: Install goupdate
        uses: ./.github/actions/_goupdate-install
        with:
          goupdate-repo: ${{ env.GOUPDATE_REPO }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Apply updates
        id: goupdate
        uses: ./.github/actions/_goupdate-update
        with:
          rule: ${{ needs.prepare.outputs.rules }}
          update-type: ${{ needs.prepare.outputs.update-type }}
          exclude-packages: ${{ env.EXCLUDE_PACKAGES }}

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Run tests
        if: steps.changes.outputs.has_changes == 'true' && env.TEST_COMMAND != ''
        run: ${{ env.TEST_COMMAND }}
        continue-on-error: true

      - name: Commit and create PR
        if: steps.changes.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          UPDATE_TYPE: ${{ needs.prepare.outputs.update-type }}
          UPDATE_OUTPUT: ${{ steps.goupdate.outputs.update-output }}
        run: |
          DATE=$(date -u +%Y-%m-%d)
          TYPE=$(echo "$UPDATE_TYPE" | sed 's/\b\(.\)/\u\1/')
          TITLE=$(echo "${{ env.PR_TITLE }}" | sed "s/{date}/$DATE/g" | sed "s/{type}/$TYPE/g")

          git add -A
          git commit -m "$TITLE"
          git push -u origin "${{ env.UPDATE_BRANCH }}"

          # Build PR body with unified output
          BODY="## Automated Dependency Update

          This PR was automatically created by the dependency update workflow.

          \`\`\`
          $UPDATE_OUTPUT
          \`\`\`
          "

          gh pr create \
            --title "$TITLE" \
            --body "$BODY" \
            --base "${{ env.TARGET_BRANCH }}" \
            --head "${{ env.UPDATE_BRANCH }}"

  summary:
    needs: [prepare, check, update]
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 2
    steps:
      - env:
          CHECK_SUMMARY: ${{ needs.check.outputs.summary }}
          RULES: ${{ needs.prepare.outputs.rules }}
        run: |
          echo "## Auto Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Rules:** $RULES" >> $GITHUB_STEP_SUMMARY
          if [ -n "$CHECK_SUMMARY" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Updates:** $CHECK_SUMMARY" >> $GITHUB_STEP_SUMMARY
          fi

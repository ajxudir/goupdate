# GoUpdate - Auto Update Workflow
# Automated dependency updates via PR to staging branch
#
# Triggers:
#   - Schedule (weekly): Check dependencies → Create PR with updates
#   - Manual dispatch: check-only or update mode
#
# Flow:
#   1. Check for dependency updates
#   2. Apply updates and run tests
#   3. Create PR to target branch
#   4. If AUTO_MERGE_UPDATES is true: wait for checks, merge PR
#   5. If AUTO_MERGE_UPDATES is false: leave PR for manual review
#
# Configuration (modify in env section below):
#   - ENABLE_* flags: Enable/disable package managers
#   - *_VERSION: Runtime versions
#   - UPDATE_BRANCH_NAME: Branch name for dependency updates
#   - UPDATE_TARGET_BRANCH: Branch to merge updates into
#   - AUTO_MERGE_UPDATES: Enable auto-merge for update PRs
#   - PR_TITLE: PR title template (use {date} and {type} placeholders)
#   - COMMIT_MESSAGE: Commit message template
#   - EXCLUDE_PACKAGES: Packages to skip updating

name: GoUpdate - Auto Update

on:
  schedule:
    - cron: '0 0 * * 1'  # Weekly on Monday
  workflow_dispatch:
    inputs:
      mode:
        description: 'Operation mode'
        required: true
        default: 'update'
        type: choice
        options:
          - check-only
          - update
      update-type:
        description: 'Dependency update type'
        required: false
        default: 'minor'
        type: choice
        options:
          - minor
          - patch

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

# ============================================================================
# CONFIGURATION - Modify for your project
# ============================================================================
env:
  GOUPDATE_REPO: 'ajxudir/goupdate'

  # Package Managers (set to 'true' to enable)
  ENABLE_NPM: 'false'
  ENABLE_YARN: 'false'
  ENABLE_PNPM: 'true'
  ENABLE_COMPOSER: 'false'
  ENABLE_PIP: 'false'
  ENABLE_PIPENV: 'false'
  ENABLE_GO: 'false'
  ENABLE_NUGET: 'false'

  # Runtime Versions
  NODE_VERSION: '20'
  PHP_VERSION: '8.2'
  PYTHON_VERSION: '3.12'
  GO_VERSION: '1.24'
  DOTNET_VERSION: '8.0'

  # Branches
  UPDATE_BRANCH_NAME: 'goupdate/auto-update-minor'
  UPDATE_TARGET_BRANCH: 'stage-updates'

  # Auto-merge
  AUTO_MERGE_UPDATES: 'true'

  # PR title template - use {date} for current date, {type} for update type (minor/patch/all)
  PR_TITLE: 'GoUpdate: Auto update - {type} ({date})'
  # Commit message template - supports {date} and {type} placeholders
  COMMIT_MESSAGE: 'GoUpdate: Auto update - {type} ({date})'
  EXCLUDE_PACKAGES: ''

permissions:
  contents: write
  pull-requests: write
  checks: read

jobs:
  # ============================================================================
  # Prepare - Determine what actions to take based on trigger
  # ============================================================================
  prepare:
    name: Prepare
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      run-dependency-check: ${{ steps.config.outputs.run_dependency_check }}
      run-updates: ${{ steps.config.outputs.run_updates }}
      check-only: ${{ steps.config.outputs.check_only }}
      update-type: ${{ steps.config.outputs.update_type }}
      auto-merge-updates: ${{ steps.config.outputs.auto_merge_updates }}
      rules: ${{ steps.config.outputs.rules }}
      use-node: ${{ steps.config.outputs.use_node }}
      use-php: ${{ steps.config.outputs.use_php }}
      use-python: ${{ steps.config.outputs.use_python }}
      use-go: ${{ steps.config.outputs.use_go }}
      use-dotnet: ${{ steps.config.outputs.use_dotnet }}

    steps:
      - name: Validate GitHub App credentials
        env:
          HAS_APP_ID: ${{ secrets.GOUPDATE_APP_ID != '' }}
          HAS_APP_PRIVATE_KEY: ${{ secrets.GOUPDATE_APP_PRIVATE_KEY != '' }}
        run: |
          if [ "$HAS_APP_ID" != "true" ] || [ "$HAS_APP_PRIVATE_KEY" != "true" ]; then
            echo "::error::GoUpdate: GitHub App credentials required"
            echo ""
            echo "To enable auto-merge, configure these repository secrets:"
            echo "  - GOUPDATE_APP_ID"
            echo "  - GOUPDATE_APP_PRIVATE_KEY"
            echo ""
            echo "See: https://github.com/${{ github.repository }}#github-app-setup"
            exit 1
          fi

      - name: Determine actions
        id: config
        env:
          AUTO_MERGE: ${{ env.AUTO_MERGE_UPDATES }}
        run: |
          EVENT="${{ github.event_name }}"
          MODE="${{ github.event.inputs.mode }}"
          UPDATE_TYPE="${{ github.event.inputs.update-type }}"

          echo "Event: $EVENT, Mode: $MODE, Update-Type: $UPDATE_TYPE, Auto-Merge: $AUTO_MERGE"

          # Build rules list from ENABLE_* flags
          RULES=""
          [ "$ENABLE_NPM" = "true" ] && RULES="${RULES}npm,"
          [ "$ENABLE_YARN" = "true" ] && RULES="${RULES}yarn,"
          [ "$ENABLE_PNPM" = "true" ] && RULES="${RULES}pnpm,"
          [ "$ENABLE_COMPOSER" = "true" ] && RULES="${RULES}composer,"
          [ "$ENABLE_PIP" = "true" ] && RULES="${RULES}requirements,"
          [ "$ENABLE_PIPENV" = "true" ] && RULES="${RULES}pipfile,"
          [ "$ENABLE_GO" = "true" ] && RULES="${RULES}mod,"
          [ "$ENABLE_NUGET" = "true" ] && RULES="${RULES}nuget,"
          RULES="${RULES%,}"
          echo "rules=$RULES" >> $GITHUB_OUTPUT

          # Detect needed runtimes
          USE_NODE="false"
          USE_PHP="false"
          USE_PYTHON="false"
          USE_GO="false"
          USE_DOTNET="false"
          [[ "$ENABLE_NPM" = "true" || "$ENABLE_YARN" = "true" || "$ENABLE_PNPM" = "true" ]] && USE_NODE="true"
          [ "$ENABLE_COMPOSER" = "true" ] && USE_PHP="true"
          [[ "$ENABLE_PIP" = "true" || "$ENABLE_PIPENV" = "true" ]] && USE_PYTHON="true"
          [ "$ENABLE_GO" = "true" ] && USE_GO="true"
          [ "$ENABLE_NUGET" = "true" ] && USE_DOTNET="true"

          echo "use_node=$USE_NODE" >> $GITHUB_OUTPUT
          echo "use_php=$USE_PHP" >> $GITHUB_OUTPUT
          echo "use_python=$USE_PYTHON" >> $GITHUB_OUTPUT
          echo "use_go=$USE_GO" >> $GITHUB_OUTPUT
          echo "use_dotnet=$USE_DOTNET" >> $GITHUB_OUTPUT

          # Pass through auto-merge setting
          echo "auto_merge_updates=$AUTO_MERGE" >> $GITHUB_OUTPUT

          case "$EVENT" in
            schedule)
              echo "run_dependency_check=true" >> $GITHUB_OUTPUT
              echo "run_updates=true" >> $GITHUB_OUTPUT
              echo "check_only=false" >> $GITHUB_OUTPUT
              echo "update_type=minor" >> $GITHUB_OUTPUT
              ;;
            workflow_dispatch)
              case "$MODE" in
                check-only)
                  echo "run_dependency_check=true" >> $GITHUB_OUTPUT
                  echo "run_updates=false" >> $GITHUB_OUTPUT
                  echo "check_only=true" >> $GITHUB_OUTPUT
                  echo "update_type=${UPDATE_TYPE:-minor}" >> $GITHUB_OUTPUT
                  ;;
                update)
                  echo "run_dependency_check=true" >> $GITHUB_OUTPUT
                  echo "run_updates=true" >> $GITHUB_OUTPUT
                  echo "check_only=false" >> $GITHUB_OUTPUT
                  echo "update_type=${UPDATE_TYPE:-minor}" >> $GITHUB_OUTPUT
                  ;;
                *)
                  echo "run_dependency_check=true" >> $GITHUB_OUTPUT
                  echo "run_updates=true" >> $GITHUB_OUTPUT
                  echo "check_only=false" >> $GITHUB_OUTPUT
                  echo "update_type=${UPDATE_TYPE:-minor}" >> $GITHUB_OUTPUT
                  ;;
              esac
              ;;
          esac

          echo "Rules: $RULES"

  # ============================================================================
  # Check for dependency updates
  # ============================================================================
  check-updates:
    name: Check Updates
    needs: prepare
    if: needs.prepare.outputs.run-dependency-check == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      has-updates: ${{ steps.goupdate.outputs.has-updates }}
      has-major-only: ${{ steps.goupdate.outputs.has-major-only }}
      summary: ${{ steps.goupdate.outputs.summary }}
      outdated-output: ${{ steps.goupdate.outputs.outdated-output }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure target branch exists
        uses: ./.github/actions/_git-branch
        with:
          branch: ${{ env.UPDATE_TARGET_BRANCH }}
          base: ${{ github.event.repository.default_branch }}
          create-if-missing: 'true'
          push: 'true'

      # Setup runtimes
      - name: Setup Node.js
        if: needs.prepare.outputs.use-node == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Enable corepack
        if: env.ENABLE_YARN == 'true' || env.ENABLE_PNPM == 'true'
        run: corepack enable

      - name: Setup PHP
        if: needs.prepare.outputs.use-php == 'true'
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}

      - name: Setup Python
        if: needs.prepare.outputs.use-python == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Setup Go
        if: needs.prepare.outputs.use-go == 'true'
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Setup .NET
        if: needs.prepare.outputs.use-dotnet == 'true'
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      # Install dependencies
      - if: env.ENABLE_NPM == 'true'
        run: npm ci
      - if: env.ENABLE_YARN == 'true'
        run: yarn install --frozen-lockfile
      - if: env.ENABLE_PNPM == 'true'
        run: pnpm install --frozen-lockfile
      - if: env.ENABLE_COMPOSER == 'true'
        run: composer install --no-interaction
      - if: env.ENABLE_PIP == 'true'
        run: pip install -r requirements.txt
      - if: env.ENABLE_PIPENV == 'true'
        run: pip install pipenv && pipenv install
      - if: env.ENABLE_NUGET == 'true'
        run: dotnet restore

      - name: Install goupdate
        uses: ./.github/actions/_goupdate-install
        with:
          goupdate-repo: ${{ env.GOUPDATE_REPO }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for updates
        id: goupdate
        uses: ./.github/actions/_goupdate-check
        with:
          rule: ${{ needs.prepare.outputs.rules }}
          exclude-packages: ${{ env.EXCLUDE_PACKAGES }}

      - name: Generate job summary
        env:
          SUMMARY: ${{ steps.goupdate.outputs.summary }}
        run: |
          echo "## GoUpdate - Check Updates" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Update check complete: $SUMMARY" >> $GITHUB_STEP_SUMMARY

      - name: Fail on major-only updates
        if: steps.goupdate.outputs.has-major-only == 'true' && steps.goupdate.outputs.has-updates == 'false'
        env:
          SUMMARY: ${{ steps.goupdate.outputs.summary }}
        run: |
          echo "::error::GoUpdate: Only major updates available"
          echo ""
          echo "════════════════════════════════════════════════════════════════"
          echo "⚠️  MAJOR UPDATES REQUIRE MANUAL REVIEW"
          echo "════════════════════════════════════════════════════════════════"
          echo ""
          echo "Major updates may contain breaking changes. To resolve:"
          echo "  1. Review changelogs for breaking changes"
          echo "  2. Update packages manually, or"
          echo "  3. Add to EXCLUDE_PACKAGES to skip"
          echo ""
          exit 1

  # ============================================================================
  # Apply updates and create PR
  # ============================================================================
  apply-updates:
    name: Apply Updates
    needs: [prepare, check-updates]
    if: |
      needs.prepare.outputs.run-updates == 'true' &&
      needs.check-updates.outputs.has-updates == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      updated-count: ${{ steps.goupdate.outputs.updated-count }}
      has-changes: ${{ steps.goupdate.outputs.has-changes }}
      updated-packages: ${{ steps.goupdate.outputs.updated-packages }}
      update-output: ${{ steps.goupdate.outputs.update-output }}
      pr-url: ${{ steps.pr.outputs.pr-url }}
      pr-number: ${{ steps.pr.outputs.pr-number }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure target branch exists
        uses: ./.github/actions/_git-branch
        with:
          branch: ${{ env.UPDATE_TARGET_BRANCH }}
          base: ${{ github.event.repository.default_branch }}
          create-if-missing: 'true'
          push: 'true'

      # Setup runtimes
      - name: Setup Node.js
        if: needs.prepare.outputs.use-node == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Enable corepack
        if: env.ENABLE_YARN == 'true' || env.ENABLE_PNPM == 'true'
        run: corepack enable

      - name: Setup PHP
        if: needs.prepare.outputs.use-php == 'true'
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}

      - name: Setup Python
        if: needs.prepare.outputs.use-python == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Setup Go
        if: needs.prepare.outputs.use-go == 'true'
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Setup .NET
        if: needs.prepare.outputs.use-dotnet == 'true'
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      # Install dependencies
      - if: env.ENABLE_NPM == 'true'
        run: npm ci
      - if: env.ENABLE_YARN == 'true'
        run: yarn install --frozen-lockfile
      - if: env.ENABLE_PNPM == 'true'
        run: pnpm install --frozen-lockfile
      - if: env.ENABLE_COMPOSER == 'true'
        run: composer install --no-interaction
      - if: env.ENABLE_PIP == 'true'
        run: pip install -r requirements.txt
      - if: env.ENABLE_PIPENV == 'true'
        run: pip install pipenv && pipenv install
      - if: env.ENABLE_NUGET == 'true'
        run: dotnet restore

      - name: Create update branch
        uses: ./.github/actions/_git-branch
        with:
          branch: ${{ env.UPDATE_BRANCH_NAME }}
          base: ${{ env.UPDATE_TARGET_BRANCH }}
          delete-remote: 'true'
          push: 'false'

      - name: Install goupdate
        uses: ./.github/actions/_goupdate-install
        with:
          goupdate-repo: ${{ env.GOUPDATE_REPO }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Apply updates
        id: goupdate
        uses: ./.github/actions/_goupdate-update
        with:
          rule: ${{ needs.prepare.outputs.rules }}
          update-type: ${{ needs.prepare.outputs.update-type }}
          exclude-packages: ${{ env.EXCLUDE_PACKAGES }}

      - name: Generate messages
        id: messages
        if: steps.goupdate.outputs.has-changes == 'true'
        env:
          PR_TITLE_TEMPLATE: ${{ env.PR_TITLE }}
          COMMIT_MSG_TEMPLATE: ${{ env.COMMIT_MESSAGE }}
          UPDATE_TYPE: ${{ needs.prepare.outputs.update-type }}
        run: |
          DATE=$(date -u +%Y-%m-%d)
          # Capitalize first letter of update type
          TYPE=$(echo "$UPDATE_TYPE" | sed 's/\b\(.\)/\u\1/')

          # Generate PR title
          TITLE=$(echo "$PR_TITLE_TEMPLATE" | sed "s/{date}/$DATE/g" | sed "s/{type}/$TYPE/g")
          echo "pr_title=$TITLE" >> $GITHUB_OUTPUT

          # Generate commit message
          COMMIT_MSG=$(echo "$COMMIT_MSG_TEMPLATE" | sed "s/{date}/$DATE/g" | sed "s/{type}/$TYPE/g")
          echo "commit_msg=$COMMIT_MSG" >> $GITHUB_OUTPUT

      - name: Commit and push changes
        if: steps.goupdate.outputs.has-changes == 'true'
        env:
          UPDATE_OUTPUT: ${{ steps.goupdate.outputs.update-output }}
          COMMIT_MSG: ${{ steps.messages.outputs.commit_msg }}
        run: |
          # Extract package versions from update output (format: "package v1.0.0 → v2.0.0")
          FORMATTED_PKGS=$(echo "$UPDATE_OUTPUT" | grep -E "^\s+\S+\s+v?[0-9]" | sed 's/^[[:space:]]*/- /' | head -20)

          git add -A
          git commit -m "$(cat <<EOF
          $COMMIT_MSG

          Updated packages:
          $FORMATTED_PKGS
          EOF
          )"
          git push -u origin "${{ env.UPDATE_BRANCH_NAME }}"

      - name: Generate GitHub App token
        id: app-token
        if: steps.goupdate.outputs.has-changes == 'true'
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.GOUPDATE_APP_ID }}
          private-key: ${{ secrets.GOUPDATE_APP_PRIVATE_KEY }}

      - name: Format PR body
        id: pr-body
        if: steps.goupdate.outputs.has-changes == 'true'
        env:
          UPDATE_OUTPUT: ${{ steps.goupdate.outputs.update-output }}
        run: |
          {
            echo "body<<PR_BODY_EOF_7e3c1a"
            echo "## GoUpdate - Automated Dependency Update"
            echo ""
            echo '```'
            echo "$UPDATE_OUTPUT"
            echo '```'
            echo ""
            echo "---"
            echo "*Created by GoUpdate*"
            echo "PR_BODY_EOF_7e3c1a"
          } >> $GITHUB_OUTPUT

      - name: Create Pull Request
        id: pr
        if: steps.goupdate.outputs.has-changes == 'true'
        uses: ./.github/actions/_gh-pr
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          title: ${{ steps.messages.outputs.pr_title }}
          body: ${{ steps.pr-body.outputs.body }}
          base: ${{ env.UPDATE_TARGET_BRANCH }}
          head: ${{ env.UPDATE_BRANCH_NAME }}
          auto-merge: 'false'
          merge-method: 'squash'
          delete-branch: 'false'

      - name: Generate job summary
        if: steps.goupdate.outputs.has-changes == 'true'
        env:
          PR_URL: ${{ steps.pr.outputs.pr-url }}
          PR_NUMBER: ${{ steps.pr.outputs.pr-number }}
          UPDATE_BRANCH: ${{ env.UPDATE_BRANCH_NAME }}
          TARGET_BRANCH: ${{ env.UPDATE_TARGET_BRANCH }}
          UPDATE_OUTPUT: ${{ steps.goupdate.outputs.update-output }}
        run: |
          {
            echo "## GoUpdate - Apply Updates"
            echo ""
            echo "### PR Created"
            echo "- **PR:** [#$PR_NUMBER]($PR_URL)"
            echo "- **Branch:** \`$UPDATE_BRANCH\` → \`$TARGET_BRANCH\`"
            echo ""
            echo '```'
            echo "$UPDATE_OUTPUT"
            echo '```'
          } >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Wait for PR checks and merge
  # ============================================================================
  merge-pr:
    name: Merge PR
    needs: [prepare, apply-updates]
    if: |
      needs.prepare.outputs.auto-merge-updates == 'true' &&
      needs.apply-updates.outputs.pr-number != '' &&
      needs.apply-updates.outputs.has-changes == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      merged: ${{ steps.wait-merge.outputs.merged }}
      checks-passed: ${{ steps.wait-merge.outputs.checks_passed }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.GOUPDATE_APP_ID }}
          private-key: ${{ secrets.GOUPDATE_APP_PRIVATE_KEY }}

      - name: Wait for PR checks and merge
        id: wait-merge
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          PR_NUMBER: ${{ needs.apply-updates.outputs.pr-number }}
          REPO: ${{ github.repository }}
        run: |
          echo "Waiting for PR #$PR_NUMBER checks to pass before merging..."
          echo ""

          MAX_ATTEMPTS=15
          ATTEMPT=0
          CHECKS_COMPLETE=false

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "═══════════════════════════════════════════════════════════════"
            echo "Checking PR status (attempt $ATTEMPT/$MAX_ATTEMPTS)..."

            if ! PR_DATA=$(gh api "repos/$REPO/pulls/$PR_NUMBER" 2>&1); then
              echo "Failed to fetch PR data, retrying..."
              sleep 30
              continue
            fi

            STATE=$(echo "$PR_DATA" | jq -r '.state')
            MERGED=$(echo "$PR_DATA" | jq -r '.merged')
            HEAD_SHA=$(echo "$PR_DATA" | jq -r '.head.sha')

            if [ "$MERGED" = "true" ]; then
              echo "✅ PR #$PR_NUMBER has been merged!"
              echo "merged=true" >> $GITHUB_OUTPUT
              echo "checks_passed=true" >> $GITHUB_OUTPUT
              exit 0
            fi

            if [ "$STATE" = "closed" ]; then
              echo "❌ PR #$PR_NUMBER was closed without merging"
              echo "merged=false" >> $GITHUB_OUTPUT
              echo "checks_passed=false" >> $GITHUB_OUTPUT
              exit 1
            fi

            if [ "$CHECKS_COMPLETE" = "false" ]; then
              if ! CHECKS_JSON=$(gh api "repos/$REPO/commits/$HEAD_SHA/check-runs" 2>&1); then
                sleep 30
                continue
              fi

              if echo "$CHECKS_JSON" | jq -e '.check_runs' > /dev/null 2>&1; then
                TOTAL_CHECKS=$(echo "$CHECKS_JSON" | jq '.total_count')
                PENDING=$(echo "$CHECKS_JSON" | jq '[.check_runs[] | select(.status != "completed")] | length')
                FAILED=$(echo "$CHECKS_JSON" | jq '[.check_runs[] | select(.status == "completed" and (.conclusion == "failure" or .conclusion == "cancelled"))] | length')

                echo "Check runs: $TOTAL_CHECKS total, $PENDING pending, $FAILED failed"

                if [ "$FAILED" -gt 0 ]; then
                  echo "❌ PR checks failed!"
                  echo "merged=false" >> $GITHUB_OUTPUT
                  echo "checks_passed=false" >> $GITHUB_OUTPUT
                  exit 1
                fi

                if [ "$PENDING" -eq 0 ] && [ "$TOTAL_CHECKS" -gt 0 ]; then
                  echo "✅ All PR checks passed!"
                  CHECKS_COMPLETE=true
                  echo "checks_passed=true" >> $GITHUB_OUTPUT

                  if gh pr merge "$PR_NUMBER" --squash --delete-branch 2>&1; then
                    echo "✅ PR #$PR_NUMBER merged successfully!"
                    echo "merged=true" >> $GITHUB_OUTPUT
                    exit 0
                  fi
                elif [ "$TOTAL_CHECKS" -eq 0 ]; then
                  echo "No CI checks configured, proceeding with merge..."
                  CHECKS_COMPLETE=true
                  echo "checks_passed=true" >> $GITHUB_OUTPUT

                  if gh pr merge "$PR_NUMBER" --squash --delete-branch 2>&1; then
                    echo "✅ PR #$PR_NUMBER merged successfully!"
                    echo "merged=true" >> $GITHUB_OUTPUT
                    exit 0
                  fi
                fi
              fi
            fi

            sleep 30
          done

          echo "❌ Timeout waiting for PR to merge"
          echo "merged=false" >> $GITHUB_OUTPUT
          echo "checks_passed=false" >> $GITHUB_OUTPUT
          exit 1

      - name: Generate job summary
        if: always()
        env:
          PR_URL: ${{ needs.apply-updates.outputs.pr-url }}
          PR_NUMBER: ${{ needs.apply-updates.outputs.pr-number }}
          MERGED: ${{ steps.wait-merge.outputs.merged }}
        run: |
          {
            echo "## GoUpdate - Merge PR"
            echo ""
            echo "- **PR:** [#$PR_NUMBER]($PR_URL)"
            if [ "$MERGED" = "true" ]; then
              echo "- **Status:** ✅ Merged"
            else
              echo "- **Status:** ❌ Not merged"
            fi
          } >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Summary
  # ============================================================================
  summary:
    name: Summary
    needs: [prepare, check-updates, apply-updates, merge-pr]
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Generate summary
        env:
          EVENT: ${{ github.event_name }}
          MODE: ${{ github.event.inputs.mode }}
          CHECK_SUMMARY: ${{ needs.check-updates.outputs.summary }}
          UPDATE_OUTPUT: ${{ needs.apply-updates.outputs.update-output }}
          PR_URL: ${{ needs.apply-updates.outputs.pr-url }}
          PR_NUMBER: ${{ needs.apply-updates.outputs.pr-number }}
          CHECK_RESULT: ${{ needs.check-updates.result }}
          APPLY_RESULT: ${{ needs.apply-updates.result }}
          PR_MERGED: ${{ needs.merge-pr.outputs.merged }}
          AUTO_MERGE_ENABLED: ${{ needs.prepare.outputs.auto-merge-updates }}
          TARGET_BRANCH: ${{ env.UPDATE_TARGET_BRANCH }}
        run: |
          echo "## GoUpdate - Auto Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** $EVENT" >> $GITHUB_STEP_SUMMARY
          if [ -n "$MODE" ]; then
            echo "**Mode:** $MODE" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # PR info if created
          if [ -n "$PR_URL" ]; then
            echo "### Pull Request" >> $GITHUB_STEP_SUMMARY
            echo "- **PR:** [#$PR_NUMBER]($PR_URL)" >> $GITHUB_STEP_SUMMARY
            if [ "$AUTO_MERGE_ENABLED" = "true" ]; then
              if [ "$PR_MERGED" = "true" ]; then
                echo "- **Status:** ✅ Merged" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "- **Status:** Awaiting manual review" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Show Check Updates summary
          if [ "$CHECK_RESULT" = "success" ] && [ -n "$CHECK_SUMMARY" ]; then
            echo "### Check Updates" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Update check complete: $CHECK_SUMMARY" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Show Apply Updates output
          if [ "$APPLY_RESULT" = "success" ] && [ -n "$UPDATE_OUTPUT" ]; then
            echo "### Apply Updates" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "$UPDATE_OUTPUT" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

          # What happens next - show only when PR was merged
          if [ "$PR_MERGED" = "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### What Happens Next" >> $GITHUB_STEP_SUMMARY
            echo "The PR was merged to \`$TARGET_BRANCH\`." >> $GITHUB_STEP_SUMMARY
          fi

# Auto Update Workflow for Frontend (pnpm)
# Automated dependency updates via PR
#
# Based on matematikk-mooc/frontend project
#
# Usage:
#   1. Copy this .github folder to your repository
#   2. Modify the env section below for your project
#   3. Set up GitHub App for auto-merge (optional)
#   4. Push to your repository
#
# Requirements:
#   - Node.js (version specified in NODE_VERSION)
#   - pnpm (auto-enabled via corepack)
#
# Update Policy:
#   - Minor/Patch updates: Applied automatically
#   - Major updates: Alerts only, does not block other updates

name: Auto Update Dependencies

on:
  schedule:
    - cron: '0 0 * * 1'  # Weekly on Monday at UTC midnight

  workflow_dispatch:
    inputs:
      mode:
        description: 'Operation mode'
        required: true
        default: 'update'
        type: choice
        options:
          - check-only   # Just check for updates, no changes
          - update       # Check + apply updates + create PR
      update-type:
        description: 'Dependency update type'
        required: false
        default: 'minor'
        type: choice
        options:
          - minor
          - patch

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

# ============================================================================
# CONFIGURATION - Modify for your project
# ============================================================================
env:
  # Goupdate source
  GOUPDATE_REPO: 'ajxudir/goupdate'

  # Package manager: npm, yarn, pnpm, composer, mod
  PACKAGE_MANAGER: 'pnpm'

  # Node.js version
  NODE_VERSION: '20'

  # Branch settings
  UPDATE_BRANCH: 'goupdate/auto-update'
  TARGET_BRANCH: 'stage-updates'

  # PR settings - use {date} for current date, {type} for update type
  PR_TITLE: 'chore(deps): Auto update - {type} ({date})'
  COMMIT_MESSAGE: 'chore(deps): Auto update - {type} ({date})'

  # Test command (set to empty to skip)
  TEST_COMMAND: 'pnpm run test'

  # Packages to exclude (comma-separated)
  EXCLUDE_PACKAGES: ''

permissions:
  contents: write
  pull-requests: write

jobs:
  # ============================================================================
  # Prepare - Determine what actions to take based on trigger
  # ============================================================================
  prepare:
    name: Prepare
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      run-updates: ${{ steps.config.outputs.run_updates }}
      check-only: ${{ steps.config.outputs.check_only }}
      update-type: ${{ steps.config.outputs.update_type }}

    steps:
      - name: Determine actions
        id: config
        run: |
          EVENT="${{ github.event_name }}"
          MODE="${{ github.event.inputs.mode }}"
          TYPE="${{ github.event.inputs.update-type }}"

          echo "Event: $EVENT, Mode: $MODE, Update-Type: $TYPE"

          case "$EVENT" in
            schedule)
              echo "run_updates=true" >> $GITHUB_OUTPUT
              echo "check_only=false" >> $GITHUB_OUTPUT
              echo "update_type=minor" >> $GITHUB_OUTPUT
              ;;
            workflow_dispatch)
              case "$MODE" in
                check-only)
                  echo "run_updates=false" >> $GITHUB_OUTPUT
                  echo "check_only=true" >> $GITHUB_OUTPUT
                  echo "update_type=${TYPE:-minor}" >> $GITHUB_OUTPUT
                  ;;
                update)
                  echo "run_updates=true" >> $GITHUB_OUTPUT
                  echo "check_only=false" >> $GITHUB_OUTPUT
                  echo "update_type=${TYPE:-minor}" >> $GITHUB_OUTPUT
                  ;;
                *)
                  echo "run_updates=true" >> $GITHUB_OUTPUT
                  echo "check_only=false" >> $GITHUB_OUTPUT
                  echo "update_type=${TYPE:-minor}" >> $GITHUB_OUTPUT
                  ;;
              esac
              ;;
          esac

  # ============================================================================
  # Check for dependency updates
  # ============================================================================
  check-updates:
    name: Check Updates
    needs: prepare
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      has-updates: ${{ steps.check.outputs.has-updates }}
      summary: ${{ steps.check.outputs.summary }}
      outdated-output: ${{ steps.check.outputs.outdated-output }}

    steps:
      - name: Checkout main first
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Ensure target branch exists
        uses: ./.github/actions/_git-branch
        with:
          branch: ${{ env.TARGET_BRANCH }}
          base: main
          create-if-missing: 'true'
          push: 'true'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Enable corepack for pnpm
        run: corepack enable

      - name: Install goupdate
        uses: ./.github/actions/_goupdate-install
        with:
          goupdate-repo: ${{ env.GOUPDATE_REPO }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for updates
        id: check
        uses: ./.github/actions/_goupdate-check
        with:
          rule: ${{ env.PACKAGE_MANAGER }}
          exclude-packages: ${{ env.EXCLUDE_PACKAGES }}

  # ============================================================================
  # Apply updates and create PR
  # ============================================================================
  apply-updates:
    name: Apply Updates
    needs: [prepare, check-updates]
    if: |
      needs.prepare.outputs.run-updates == 'true' &&
      needs.check-updates.outputs.has-updates == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      updated-count: ${{ steps.update.outputs.updated-count }}
      has-changes: ${{ steps.update.outputs.has-changes }}
      updated-packages: ${{ steps.update.outputs.updated-packages }}
      update-output: ${{ steps.update.outputs.update-output }}
      pr-url: ${{ steps.pr.outputs.pr-url }}
      pr-number: ${{ steps.pr.outputs.pr-number }}

    steps:
      - name: Checkout main first
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Ensure target branch exists
        uses: ./.github/actions/_git-branch
        with:
          branch: ${{ env.TARGET_BRANCH }}
          base: main
          create-if-missing: 'true'
          push: 'true'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Enable corepack for pnpm
        run: corepack enable

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Create update branch
        uses: ./.github/actions/_git-branch
        with:
          branch: ${{ env.UPDATE_BRANCH }}
          base: ${{ env.TARGET_BRANCH }}
          delete-remote: 'true'
          push: 'false'

      - name: Install goupdate
        uses: ./.github/actions/_goupdate-install
        with:
          goupdate-repo: ${{ env.GOUPDATE_REPO }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Apply updates
        id: update
        uses: ./.github/actions/_goupdate-update
        with:
          rule: ${{ env.PACKAGE_MANAGER }}
          update-type: ${{ needs.prepare.outputs.update-type }}
          exclude-packages: ${{ env.EXCLUDE_PACKAGES }}
          system-test-mode: 'none'

      - name: Run tests
        if: steps.update.outputs.has-changes == 'true' && env.TEST_COMMAND != ''
        run: ${{ env.TEST_COMMAND }}
        continue-on-error: true

      - name: Generate messages
        id: messages
        if: steps.update.outputs.has-changes == 'true'
        env:
          PR_TITLE_TEMPLATE: ${{ env.PR_TITLE }}
          COMMIT_MSG_TEMPLATE: ${{ env.COMMIT_MESSAGE }}
          UPDATE_TYPE: ${{ needs.prepare.outputs.update-type }}
        run: |
          DATE=$(date -u +%Y-%m-%d)
          TYPE=$(echo "$UPDATE_TYPE" | sed 's/\b\(.\)/\u\1/')

          TITLE=$(echo "$PR_TITLE_TEMPLATE" | sed "s/{date}/$DATE/g" | sed "s/{type}/$TYPE/g")
          echo "pr_title=$TITLE" >> $GITHUB_OUTPUT

          COMMIT_MSG=$(echo "$COMMIT_MSG_TEMPLATE" | sed "s/{date}/$DATE/g" | sed "s/{type}/$TYPE/g")
          echo "commit_msg=$COMMIT_MSG" >> $GITHUB_OUTPUT

      - name: Commit and push changes
        if: steps.update.outputs.has-changes == 'true'
        env:
          UPDATED_PKGS: ${{ steps.update.outputs.updated-packages }}
          COMMIT_MSG: ${{ steps.messages.outputs.commit_msg }}
        run: |
          FORMATTED_PKGS=$(echo "$UPDATED_PKGS" | tr ' ' '\n' | sed '/^$/d' | sed 's/^/- /')

          git add package.json pnpm-lock.yaml
          git commit -m "$(cat <<EOF
          $COMMIT_MSG

          Updated packages:
          $FORMATTED_PKGS
          EOF
          )"
          git push -u origin "${{ env.UPDATE_BRANCH }}"

      - name: Format PR body
        id: pr-body
        if: steps.update.outputs.has-changes == 'true'
        env:
          UPDATE_OUTPUT: ${{ steps.update.outputs.update-output }}
        run: |
          {
            echo "body<<PR_BODY_EOF_7e3c1a"
            echo "## Automated Dependency Update"
            echo ""
            echo "This PR was automatically created by the dependency update workflow."
            echo ""
            echo '```'
            echo "$UPDATE_OUTPUT"
            echo '```'
            echo ""
            echo "---"
            echo "*Created by [GoUpdate](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*"
            echo "PR_BODY_EOF_7e3c1a"
          } >> $GITHUB_OUTPUT

      - name: Create Pull Request
        id: pr
        if: steps.update.outputs.has-changes == 'true'
        uses: ./.github/actions/_gh-pr
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          title: ${{ steps.messages.outputs.pr_title }}
          body: ${{ steps.pr-body.outputs.body }}
          base: ${{ env.TARGET_BRANCH }}
          head: ${{ env.UPDATE_BRANCH }}

  # ============================================================================
  # Summary
  # ============================================================================
  summary:
    name: Summary
    needs: [prepare, check-updates, apply-updates]
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Generate summary
        env:
          EVENT: ${{ github.event_name }}
          MODE: ${{ github.event.inputs.mode }}
          HAS_UPDATES: ${{ needs.check-updates.outputs.has-updates }}
          CHECK_SUMMARY: ${{ needs.check-updates.outputs.summary }}
          UPDATE_OUTPUT: ${{ needs.apply-updates.outputs.update-output }}
          UPDATED_COUNT: ${{ needs.apply-updates.outputs.updated-count }}
          PR_URL: ${{ needs.apply-updates.outputs.pr-url }}
          PR_NUMBER: ${{ needs.apply-updates.outputs.pr-number }}
          CHECK_RESULT: ${{ needs.check-updates.result }}
          APPLY_RESULT: ${{ needs.apply-updates.result }}
        run: |
          echo "## Auto Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** $EVENT" >> $GITHUB_STEP_SUMMARY
          if [ -n "$MODE" ]; then
            echo "**Mode:** $MODE" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # PR info if created
          if [ -n "$PR_URL" ]; then
            echo "### Pull Request" >> $GITHUB_STEP_SUMMARY
            echo "**PR:** [#$PR_NUMBER]($PR_URL)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Show Check Updates summary
          if [ "$CHECK_RESULT" = "success" ] && [ -n "$CHECK_SUMMARY" ]; then
            echo "### Check Updates" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Update check complete: $CHECK_SUMMARY" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Show Apply Updates output
          if [ "$APPLY_RESULT" = "success" ] && [ -n "$UPDATE_OUTPUT" ]; then
            echo "### Apply Updates" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "$UPDATE_OUTPUT" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

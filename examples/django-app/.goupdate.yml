# Django App - goupdate configuration
# Demonstrates: groups for Python, excluding dev tools, system tests

extends: [default]

rules:
  requirements:
    groups:
      web:
        - Django
        - djangorestframework
        - gunicorn
      async:
        - celery
        - redis
      database:
        - psycopg2-binary
      testing:
        - pytest
        - pytest-django

    # Don't auto-update formatters
    ignore:
      - black
      - isort

    exclude_versions:
      - "(?i)dev"
      - "(?i)post"

# System tests for Django projects
system_tests:
  run_preflight: true
  run_mode: after_each
  stop_on_fail: true
  tests:
    # Run Django's system checks
    - name: django-check
      commands: python manage.py check
      timeout_seconds: 60

    # Run pytest with Django plugin
    - name: unit-tests
      commands: pytest -v --tb=short
      timeout_seconds: 300
      env:
        DJANGO_SETTINGS_MODULE: "myapp.settings"
      continue_on_fail: true  # Skip if pytest not installed

    # Start server and verify HTTP response
    - name: http-test
      commands: |
        # Start Django dev server in background
        python manage.py runserver 0.0.0.0:8765 &
        SERVER_PID=$!
        sleep 3

        # Verify ping endpoint returns correct JSON
        RESPONSE=$(curl -s http://localhost:8765/ping/)
        echo "Ping response: $RESPONSE"

        # Verify health endpoint
        HEALTH=$(curl -s http://localhost:8765/health/)
        echo "Health response: $HEALTH"

        # Cleanup
        kill $SERVER_PID 2>/dev/null || true

        # Check responses contain expected content
        echo "$RESPONSE" | grep -q '"message"' || { echo "ERROR: Ping failed"; exit 1; }
        echo "$HEALTH" | grep -q '"status"' || { echo "ERROR: Health failed"; exit 1; }
        echo "HTTP tests passed!"
      timeout_seconds: 60
      env:
        DJANGO_SETTINGS_MODULE: "myapp.settings"

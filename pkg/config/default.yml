# Default goupdate configuration
# This file uses the new multiline commands format with env support
# and config-based parsing. See docs/configuration.md for full schema.

# Global version exclusion patterns (pre-release versions)
# Each pattern matches a specific pre-release indicator
exclude_versions:
  - "(?i)[._-]alpha"
  - "(?i)[._-]beta"
  - "(?i)[._-]rc"
  - "(?i)[._-]pre"
  - "(?i)[._-]canary"
  - "(?i)[._-]dev"
  - "(?i)^dev-"
  - "(?i)[._-]snapshot"
  - "(?i)[._-]nightly"
  - "(?i)[._-]preview"
  - "(?i)[._-]next"

rules:
  # NPM/Node.js packages in package.json
  # Uses npm ls for maximum compatibility across package-lock.json versions (v1, v2, v3)
  npm: &js_rule
    manager: js
    include: ["**/package.json"]
    exclude: ["**/node_modules/**", "**/vendor/**"]
    format: json
    fields:
      dependencies: prod
      devDependencies: dev
    outdated:
      commands: |
        npm view {{package}} versions --json
      format: json
      timeout_seconds: 30
    update:
      commands: |
        npm install --package-lock-only --ignore-scripts
      timeout_seconds: 300
    lock_files:
      - files: ["**/package-lock.json"]
        commands: |
          npm ls --json --package-lock-only 2>/dev/null || exit 0
        timeout_seconds: 60

  # pnpm packages (extends npm rule)
  # Uses file-based extraction from pnpm-lock.yaml for fast lock resolution without node_modules
  # Supports multiple pnpm-lock.yaml versions (v6, v7, v8, v9) with conditional pattern detection
  pnpm:
    <<: *js_rule
    update:
      commands: |
        pnpm install --lockfile-only
      timeout_seconds: 300
    lock_files:
      - files: ["**/pnpm-lock.yaml"]
        format: raw
        extraction:
          # Multi-pattern extraction for different pnpm-lock.yaml versions
          # Pattern selection: detect regex matches against file content, then pattern is applied
          patterns:
            # pnpm v9 (lockfileVersion: '9.0') uses importers with 6-space indentation:
            #   '@babel/core':          or          lodash:
            #     specifier: ^7.26.9                  specifier: ^4.17.21
            #     version: 7.26.9                     version: 4.17.21
            - name: "v9"
              detect: "lockfileVersion:\\s*'9"
              pattern: '(?m)^\s{6}''?(?P<n>[@\w\-\.\/]+)''?:\s*\n\s+specifier:[^\n]+\n\s+version:\s*(?P<version>[\d\.]+)'
            # pnpm v6/v7/v8 (lockfileVersion: '6.0'/'7.0'/'8.0') uses packages section:
            #   /lodash@4.17.21:
            #     resolution: {integrity: sha512-...}
            #   /@babel/core@7.26.9:
            #     resolution: {integrity: sha512-...}
            - name: "v6_v7_v8"
              detect: "lockfileVersion:\\s*'[678]"
              pattern: '(?m)^\s*/(?P<n>@?[\w\-\.\/]+)@(?P<version>[\d\.]+):'

  # Yarn packages (extends npm rule)
  # Uses file-based extraction from yarn.lock for fast lock resolution without node_modules
  # Supports both classic (v1) and berry (v2+) formats with conditional pattern detection
  yarn:
    <<: *js_rule
    update:
      commands: |
        yarn install --mode update-lockfile 2>/dev/null || yarn install
      timeout_seconds: 300
    lock_files:
      - files: ["**/yarn.lock"]
        format: raw
        extraction:
          # Multi-pattern extraction for different yarn.lock versions
          patterns:
            # Yarn classic (v1) format - starts with "# yarn lockfile v1":
            #   lodash@^4.17.21:
            #     version "4.17.21"
            - name: "classic"
              detect: "#\\s*yarn lockfile v1"
              pattern: '(?m)^"?(?P<n>@?[\w\-\.\/]+)@[^:\n"]+:\s*\n\s+version\s+"(?P<version>[^"]+)"'
            # Yarn berry (v2+) format - has __metadata section:
            #   "lodash@npm:^4.17.21":
            #     version: 4.17.21
            - name: "berry"
              detect: "__metadata:\\s*\\n\\s+version:"
              pattern: '(?m)^"(?P<n>@?[\w\-\.\/]+)@(?:npm:)?[^"]+\":\s*\n\s+version:\s*(?P<version>[^\s\n]+)'

  # Composer/PHP packages
  composer:
    manager: php
    include: ["**/composer.json"]
    exclude: ["**/vendor/**"]
    format: json
    fields:
      require: prod
      require-dev: dev
    ignore: ["php", "ext-*"]
    outdated:
      commands: |
        composer show {{package}} --all --format=json
      format: json
      extraction:
        json_key: "versions"
      timeout_seconds: 30
    update:
      # composer update with specific package name updates only the changed package
      # NOTE: Do NOT use --with-all-dependencies as it updates dependencies recursively
      commands: |
        composer update {{package}} --no-interaction --no-scripts
      timeout_seconds: 300
    lock_files:
      - files: ["**/composer.lock"]
        format: json
        extraction:
          pattern: '(?s)"name":\s*"(?P<n>[^"]+)"\s*,\s*"version":\s*"(?P<version>[^"]+)"'

  # Python requirements.txt
  requirements:
    manager: python
    include: ["**/requirements*.txt"]
    exclude: ["**/venv/**", "**/.venv/**", "**/vendor/**", "**/node_modules/**"]
    format: raw
    fields:
      packages: prod
    extraction:
      # Pattern fixes:
      # 1. Package name must start with letter/digit (not hyphen) to exclude pip directives (-r, -e, etc.)
      # 2. Optional extras in brackets like [django,celery] are matched but not captured
      pattern: '(?m)^(?P<n>[a-zA-Z0-9][\w\-\.]*)(?:\[[^\]]+\])?(?:[ \t]*(?P<constraint>[><=~!]+)[ \t]*(?P<version>[\w\.\-\+]+)|[ \t]+(?P<version_alt>[\w\.\-\+]+))?'
    outdated:
      commands: |
        curl -s "https://pypi.org/pypi/{{package}}/json"
      format: json
      extraction:
        json_key: "releases"
      timeout_seconds: 30
    update:
      # No lock command - requirements.txt is the manifest, no separate lock file
      # The version is updated directly in requirements.txt
      timeout_seconds: 60
    # requirements.txt is self-pinning: declared versions ARE the installed versions
    self_pinning: true

  # Python Pipfile
  pipfile:
    manager: python
    include: ["**/Pipfile"]
    exclude: ["**/venv/**", "**/.venv/**", "**/vendor/**", "**/node_modules/**"]
    format: raw
    fields:
      packages: prod
      dev-packages: dev
    extraction:
      pattern: '(?m)^(?P<n>[\w\-\.]+)\s*=\s*"(?P<constraint>[><=~!]+)?\s*(?P<version>[\w\.\-\+\*]+)?'
    outdated:
      commands: |
        curl -s "https://pypi.org/pypi/{{package}}/json"
      format: json
      extraction:
        json_key: "releases"
      timeout_seconds: 30
    update:
      commands: |
        pipenv lock
      timeout_seconds: 300
    lock_files:
      - files: ["**/Pipfile.lock"]
        format: json
        extraction:
          pattern: '(?s)"(?P<n>[\w\-]+)":\s*\{[^}]*"version":\s*"==(?P<version>[^"]+)"'

  # Go modules
  mod:
    manager: golang
    include: ["**/go.mod"]
    format: raw
    fields:
      require: prod
    extraction:
      # Pattern matches both block format (indented) and single-line require statements
      # Block:  "  github.com/pkg v1.0.0"
      # Single: "require github.com/pkg v1.0.0"
      pattern: '(?m)^(?:\s+|require\s+)(?P<n>[\w\.\-\/]+)\s+(?P<version>v[\w\.\-\+]+)'
    outdated:
      commands: |
        go list -m -json -versions {{package}}
      format: json
      extraction:
        json_key: "Versions"
      timeout_seconds: 30
    update:
      # go mod tidy updates go.sum based on go.mod after version is changed
      commands: |
        go mod tidy
      timeout_seconds: 120
    lock_files:
      - files: ["**/go.sum"]
        format: raw
        extraction:
          pattern: '(?m)^(?P<n>\S+)\s+(?P<version>v[^\s]+)'

  # .NET MSBuild projects (csproj, vbproj, fsproj)
  msbuild:
    manager: dotnet
    include: ["**/*.csproj", "**/*.vbproj", "**/*.fsproj"]
    format: xml
    fields:
      ItemGroup/PackageReference: prod
    extraction:
      # Dev dependency detection: packages with PrivateAssets="all" or <PrivateAssets>all</PrivateAssets>
      dev_element: "PrivateAssets"
      dev_element_value: "all"
    outdated:
      # Uses dotnet CLI which respects NuGet.config for private feeds
      commands: |
        dotnet package search {{package}} --exact-match --format json
      format: raw
      extraction:
        # Extract all version values from JSON array of package objects
        pattern: '"version":\s*"(?P<version>[^"]+)"'
      timeout_seconds: 30
    update:
      # dotnet restore updates lock file based on csproj after version is changed
      commands: |
        dotnet restore
      timeout_seconds: 300
    lock_files:
      - files: ["**/packages.lock.json"]
        format: json
        extraction:
          pattern: '"(?P<n>[\w\.-/]+)"\s*:\s*\{\s*"resolved"\s*:\s*"(?P<version>[^"]+)"'

  # NuGet packages.config (legacy .NET)
  nuget:
    manager: dotnet
    include: ["**/packages.config"]
    format: xml
    fields:
      packages: prod
    extraction:
      path: "package"
      name_attr: "id"
      version_attr: "version"
      # Dev dependency detection: packages with developmentDependency="true"
      dev_attr: "developmentDependency"
      dev_value: "true"
    outdated:
      # Uses dotnet CLI which respects NuGet.config for private feeds
      commands: |
        dotnet package search {{package}} --exact-match --format json
      format: raw
      extraction:
        # Extract all version values from JSON array of package objects
        pattern: '"version":\s*"(?P<version>[^"]+)"'
      timeout_seconds: 30
    update:
      commands: |
        dotnet restore
      timeout_seconds: 300
    lock_files:
      - files: ["**/packages.lock.json"]
        format: json
        extraction:
          pattern: '"(?P<n>[\w\.-/]+)"\s*:\s*\{\s*"resolved"\s*:\s*"(?P<version>[^"]+)"'

# Global latest mapping defaults
latest_mapping:
  default:
    latest: "*"
